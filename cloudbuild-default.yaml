# Decrypt the file containing the key
steps:
  - name: 'gcr.io/cloud-builders/git'
    entrypoint: 'bash'
    args:
      - -exc
      - |
        # Cloud Build x GitHub integration uses source archives to fetch
        # the source, rather than Git source fetching, and as a consequence
        # does not include the .git/ directory. As a workaround, we clone
        # the repository and reset it to this build's commit sha.
        git clone 'git@github.com:cage1016/gokit-gae.git' tmp
        mv tmp/.git .git
        rm -rf tmp
        git reset "$COMMIT_SHA"
        git submodule sync --recursive
        git submodule update --init --recursive
        cd default/ng-web
        git pull
        cd ../..
        git add default/ng-web
        git config --global user.email "you@example.com"
        git config --global user.name "Your Name"
        git commit -m 'swtich release to prepare release build'

  - name: 'gcr.io/cloud-builders/npm'
    dir: 'default/ng-web'
    args:
      - install

  - name: 'gcr.io/cloud-build-testbed/ng:v9'
    dir: 'default/ng-web'
    args:
      - build
      - --prod

  - name: gcr.io/cloud-builders/gcloud
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # get mask-web short sha
        maskWebShortSha=$(git ls-files -s frontend/mask-web  | awk '{print substr($2,0,7)}')

        # deploy
        gcloud app deploy --version=${maskWebShortSha} frontend/app.yaml --no-promote -q

        echo "deploy succeeded."

timeout: "1600s"
